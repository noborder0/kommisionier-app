<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | Kommissionier-App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .search-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .search-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .search-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .scanner-icon {
            font-size: 5rem;
            opacity: 0.8;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .project-filter {
            margin-bottom: 20px;
        }

        .project-pills {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .project-pill {
            padding: 8px 20px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .project-pill:hover {
            background: #e9ecef;
        }

        .project-pill.active {
            background: #6610f2;
            color: white;
            border-color: #6610f2;
        }

        .scan-input {
            font-size: 1.5rem;
            padding: 20px;
            text-align: center;
            border: 3px solid #dee2e6;
            border-radius: 15px;
            transition: all 0.3s;
        }

        .scan-input:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .recent-searches {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .search-item {
            padding: 10px 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-item:hover {
            background: #e7f3ff;
            transform: translateX(5px);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .action-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-decoration: none;
            color: inherit;
        }

        .action-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
    </style>
</head>
<body>
<%- include('../partials/navbar') %>

<div class="container mt-4">
    <div class="search-container">
        <!-- Search Header -->
        <div class="search-header">
            <div class="scanner-icon mb-3">
                <i class="fas fa-barcode"></i>
            </div>
            <h1 class="display-5">Lieferschein suchen</h1>
            <p class="lead mb-0">Scannen Sie den Barcode oder geben Sie die Nummer ein</p>
        </div>

        <!-- Flash Messages -->
        <% if(typeof success_msg !== 'undefined' && success_msg !== '') { %>
            <div class="alert alert-success alert-dismissible fade show">
                <%= success_msg %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>

        <% if(typeof error_msg !== 'undefined' && error_msg !== '') { %>
            <div class="alert alert-danger alert-dismissible fade show">
                <%= error_msg %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>

        <% if(typeof info_msg !== 'undefined' && info_msg !== '') { %>
            <div class="alert alert-info alert-dismissible fade show">
                <%= info_msg %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>

        <!-- Search Box -->
        <div class="search-box">
            <form action="/orders/search" method="POST" id="searchForm">
                <!-- Project Filter -->
                <div class="project-filter">
                    <label class="form-label">
                        <i class="fas fa-folder"></i> Projekt-Filter (optional)
                    </label>
                    <div class="project-pills" id="projectPills">
                        <div class="project-pill active" data-project="">
                            Alle Projekte
                        </div>
                        <!-- Projekt-Pills werden dynamisch geladen -->
                    </div>
                    <input type="hidden" name="projectId" id="projectId" value="">
                </div>

                <!-- Scanner Input -->
                <div class="mb-4">
                    <label for="deliveryNoteNumber" class="form-label text-center d-block mb-3">
                        <strong>Lieferschein-Nummer oder Barcode</strong>
                    </label>
                    <input type="text"
                           id="deliveryNoteNumber"
                           name="deliveryNoteNumber"
                           class="form-control scan-input"
                           placeholder="Hier scannen oder eingeben..."
                           autocomplete="off"
                           autofocus
                           required>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            Der Scanner sendet automatisch Enter nach dem Scannen
                        </small>
                    </div>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-search"></i> Suchen
                    </button>
                </div>
            </form>
        </div>

        <!-- Recent Searches -->
        <div class="recent-searches" id="recentSearches" style="display: none;">
            <h5 class="mb-3">
                <i class="fas fa-history"></i> Letzte Suchen
            </h5>
            <div id="recentSearchesList">
                <!-- Wird dynamisch gefüllt -->
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="/orders/projects" class="action-card">
                <span class="action-icon text-primary">
                    <i class="fas fa-folder-open"></i>
                </span>
                <h5>Projekte</h5>
                <p class="text-muted mb-0">Nach Projekt suchen</p>
            </a>

            <a href="/orders" class="action-card">
                <span class="action-icon text-success">
                    <i class="fas fa-list"></i>
                </span>
                <h5>Alle Aufträge</h5>
                <p class="text-muted mb-0">Auftrags-Übersicht</p>
            </a>

            <a href="/orders/batch-pick" class="action-card">
                <span class="action-icon text-warning">
                    <i class="fas fa-boxes"></i>
                </span>
                <h5>Batch-Picking</h5>
                <p class="text-muted mb-0">Mehrere Aufträge</p>
            </a>

            <a href="/orders/sync" class="action-card">
                <span class="action-icon text-info">
                    <i class="fas fa-sync"></i>
                </span>
                <h5>Synchronisieren</h5>
                <p class="text-muted mb-0">Neue Aufträge laden</p>
            </a>
        </div>

        <!-- Scanner Info -->
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> Scanner-Tipps</h5>
            <ul class="mb-0">
                <li>Halten Sie den Scanner 10-15cm vom Barcode entfernt</li>
                <li>Der Cursor muss im Eingabefeld sein</li>
                <li>Nach dem Scannen wird automatisch gesucht</li>
                <li>Sie können auch Artikel-Barcodes scannen</li>
            </ul>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let scanBuffer = '';
    let lastInputTime = 0;
    const scanThreshold = 100;

    // Lade verfügbare Projekte
    async function loadProjects() {
        try {
            const response = await fetch('/api/projects');
            if (response.ok) {
                const projects = await response.json();
                displayProjects(projects);
            }
        } catch (error) {
            console.error('Fehler beim Laden der Projekte:', error);
        }
    }

    function displayProjects(projects) {
        const container = document.getElementById('projectPills');
        // Behalte "Alle Projekte" Pill
        const allPill = container.querySelector('[data-project=""]');

        projects.forEach(project => {
            const pill = document.createElement('div');
            pill.className = 'project-pill';
            pill.dataset.project = project.id;
            pill.innerHTML = `
                <i class="fas fa-folder me-1"></i>
                ${project.name}
                <span class="badge bg-secondary ms-2">${project.orderCount || 0}</span>
            `;
            pill.addEventListener('click', () => selectProject(project.id));
            container.appendChild(pill);
        });
    }

    function selectProject(projectId) {
        // Update active state
        document.querySelectorAll('.project-pill').forEach(pill => {
            pill.classList.remove('active');
        });

        const selectedPill = document.querySelector(`[data-project="${projectId}"]`);
        if (selectedPill) {
            selectedPill.classList.add('active');
        }

        // Update hidden input
        document.getElementById('projectId').value = projectId;
    }

    // Scanner-Logik
    document.getElementById('deliveryNoteNumber').addEventListener('input', function(e) {
        const currentTime = Date.now();

        if (currentTime - lastInputTime > scanThreshold) {
            scanBuffer = '';
        }

        scanBuffer += e.data || '';
        lastInputTime = currentTime;
    });

    document.getElementById('deliveryNoteNumber').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && this.value.trim()) {
            // Speichere in Recent Searches
            addToRecentSearches(this.value.trim());
        }
    });

    // Recent Searches
    function loadRecentSearches() {
        const searches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
        if (searches.length > 0) {
            displayRecentSearches(searches);
            document.getElementById('recentSearches').style.display = 'block';
        }
    }

    function addToRecentSearches(searchTerm) {
        let searches = JSON.parse(localStorage.getItem('recentSearches') || '[]');

        // Entferne Duplikate
        searches = searches.filter(s => s !== searchTerm);

        // Füge am Anfang hinzu
        searches.unshift(searchTerm);

        // Behalte nur die letzten 5
        searches = searches.slice(0, 5);

        localStorage.setItem('recentSearches', JSON.stringify(searches));
    }

    function displayRecentSearches(searches) {
        const container = document.getElementById('recentSearchesList');
        container.innerHTML = '';

        searches.forEach(search => {
            const item = document.createElement('div');
            item.className = 'search-item';
            item.innerHTML = `
                <span>
                    <i class="fas fa-clock me-2"></i>
                    ${search}
                </span>
                <button class="btn btn-sm btn-outline-primary" onclick="searchFor('${search}')">
                    <i class="fas fa-search"></i>
                </button>
            `;
            container.appendChild(item);
        });
    }

    function searchFor(term) {
        document.getElementById('deliveryNoteNumber').value = term;
        document.getElementById('searchForm').submit();
    }

    // Initialisierung
    document.addEventListener('DOMContentLoaded', function() {
        loadProjects();
        loadRecentSearches();

        // Auto-Focus
        document.getElementById('deliveryNoteNumber').focus();
    });

    // Projekt-Pills Click Handler
    document.querySelectorAll('.project-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            selectProject(this.dataset.project);
        });
    });

    // Keyboard Shortcuts
    document.addEventListener('keydown', function(e) {
        // F2 = Focus auf Scanner
        if (e.key === 'F2') {
            e.preventDefault();
            document.getElementById('deliveryNoteNumber').focus();
        }

        // Escape = Clear
        if (e.key === 'Escape') {
            document.getElementById('deliveryNoteNumber').value = '';
            document.getElementById('deliveryNoteNumber').focus();
        }
    });
</script>
</body>
</html>