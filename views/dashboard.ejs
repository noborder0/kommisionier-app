<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | Kommissionier-App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">Kommissionier-App</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/dashboard">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/orders">Aufträge</a>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i> <%= user.name %>
                    </a>
                    <ul class="dropdown-menu">
                        <% if (user.role === 'admin') { %>
                            <li><a class="dropdown-item" href="/auth/register">Benutzer registrieren</a></li>
                            <li><hr class="dropdown-divider"></li>
                        <% } %>
                        <li><a class="dropdown-item" href="/auth/logout">Logout</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Flash-Nachrichten -->
    <% if(typeof success_msg !== 'undefined' && success_msg !== '') { %>
        <div class="alert alert-success alert-dismissible fade show">
            <%= success_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <% if(typeof error_msg !== 'undefined' && error_msg !== '') { %>
        <div class="alert alert-danger alert-dismissible fade show">
            <%= error_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h2>Dashboard</h2>
        </div>
        <div class="card-body">
            <h4 class="mb-4">Willkommen, <%= user.name %>!</h4>

            <!-- Sync-Status Anzeige -->
            <% if (typeof syncStats !== 'undefined' && syncStats) { %>
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-sync"></i> No Border Synchronisierung
                                    <% if (syncStats.isRunning) { %>
                                        <span class="badge bg-success ms-2">Aktiv</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary ms-2">Inaktiv</span>
                                    <% } %>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Letzte Synchronisierung:</strong><br>
                                        <% if (syncStats.lastSyncTime) { %>
                                            <%= new Date(syncStats.lastSyncTime).toLocaleString('de-DE') %>
                                        <% } else { %>
                                            Noch keine
                                        <% } %>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Erfolgreiche Syncs:</strong><br>
                                        <span class="text-success"><%= syncStats.successfulSyncs %></span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Fehlgeschlagene Syncs:</strong><br>
                                        <span class="text-danger"><%= syncStats.failedSyncs %></span>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-sm btn-primary" onclick="triggerManualSync()">
                                            <i class="fas fa-sync"></i> Manuell synchronisieren
                                        </button>
                                    </div>
                                </div>
                                <% if (syncStats.lastError) { %>
                                    <div class="alert alert-warning mt-2 mb-0">
                                        <small><strong>Letzter Fehler:</strong> <%= syncStats.lastError %></small>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-search"></i> Lieferschein suchen
                            </h5>
                            <p class="card-text">Suchen Sie einen Lieferschein nach Nummer.</p>
                            <a href="/orders/search" class="btn btn-primary">Zur Suche</a>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-clipboard-list"></i> Aktuelle Aufträge
                            </h5>
                            <p class="card-text">Zeigen Sie alle aktuellen Aufträge an.</p>
                            <a href="/orders" class="btn btn-primary">Aufträge anzeigen</a>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-tag"></i> Etiketten-Generator
                            </h5>
                            <p class="card-text">Erstellen und drucken Sie Paletten- und Packstücketiketten.</p>
                            <a href="/labels" class="btn btn-primary">Zu den Etiketten</a>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-truck"></i> Versandlabels
                            </h5>
                            <p class="card-text">Erstellen Sie Versandlabels für verschiedene Transportdienste.</p>
                            <a href="/shipping" class="btn btn-primary">Zum Versand</a>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-plug"></i> API-Verbindung
                            </h5>
                            <p class="card-text">Testen Sie die Verbindung zur No Border API.</p>
                            <a href="/orders/api-test" class="btn btn-primary">API testen</a>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-sync"></i> Synchronisierung
                            </h5>
                            <p class="card-text">Synchronisieren Sie alle offenen Lieferscheine mit No Border.</p>
                            <a href="/orders/sync" class="btn btn-primary">Jetzt synchronisieren</a>
                        </div>
                    </div>
                </div>
            </div>

            <% if (user.role === 'admin') { %>
                <div class="mt-5">
                    <h4 class="mb-3">Administration</h4>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-users"></i> Benutzerverwaltung
                                    </h5>
                                    <p class="card-text">Benutzer hinzufügen, bearbeiten oder deaktivieren.</p>
                                    <a href="/auth/register" class="btn btn-primary">Benutzer verwalten</a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-cogs"></i> Systemeinstellungen
                                    </h5>
                                    <p class="card-text">Konfigurieren Sie API-Verbindungen und andere Einstellungen.</p>
                                    <a href="/settings" class="btn btn-primary">Zu den Einstellungen</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    async function triggerManualSync() {
        try {
            const response = await fetch('/api/trigger-sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                alert('Synchronisierung gestartet!');
                location.reload(); // Seite neu laden um aktualisierte Stats zu zeigen
            } else {
                alert('Fehler beim Starten der Synchronisierung: ' + result.error);
            }
        } catch (error) {
            alert('Fehler: ' + error.message);
        }
    }
</script>
</body>
</html>